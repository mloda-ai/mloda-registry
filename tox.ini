[tox]
envlist = python310 #python310, python311, python312, python313

[testenv]
usedevelop = true
passenv =
    USE_TOX_LOCK
allowlist_externals = sh, bandit
setenv =
    USE_TOX_LOCK = {env:USE_TOX_LOCK:}
commands =
    sh -c "if [ -n \"$USE_TOX_LOCK\" ]; then flock /shared/tox.lock pytest; else pytest; fi"
    ruff format --line-length 120 .
    mypy --strict --ignore-missing-imports .
    bandit -c pyproject.toml -r -q .

[testenv:testing]
description = Run only mloda-testing tests
usedevelop = true
commands =
    pytest mloda/testing/tests/ -v

[testenv:community-example]
description = Run only mloda-community-example tests
usedevelop = true
commands =
    pytest mloda/community/feature_groups/example/tests/ -v

[testenv:community-example-a]
description = Run only mloda-community-example-a tests
usedevelop = true
commands =
    pytest mloda/community/feature_groups/example/example_a/tests/ -v

[testenv:community-example-b]
description = Run only mloda-community-example-b tests
usedevelop = true
commands =
    pytest mloda/community/feature_groups/example/example_b/tests/ -v

[testenv:registry]
description = Run only mloda-registry tests
usedevelop = true
commands =
    pytest mloda/registry/tests/ -v

[testenv:enterprise-example]
description = Run only mloda-enterprise-example tests
usedevelop = true
commands =
    pytest mloda/enterprise/ -v

[testenv:verify-builds]
description = Verify all packages build with correct versions
usedevelop = true
extras = dev
allowlist_externals = uv
commands =
    python scripts/verify_builds.py

[testenv:check-generated]
description = Check pyproject.toml files are up-to-date with config
usedevelop = true
extras = dev
commands =
    python scripts/generate_pyproject.py --check

[testenv:security]
description = CVE scanning of published packages
skip_install = true
deps =
    pip-audit
allowlist_externals = sh, mkdir
commands =
    mkdir -p security-reports
    sh -c "pip uninstall -y mloda-registry mloda-testing mloda-community mloda-enterprise mloda-community-example mloda-community-example-a 2>/dev/null || true"
    sh -c "pip install mloda-registry=={env:MLODA_REGISTRY_VERSION:0.2.0} mloda-testing=={env:MLODA_REGISTRY_VERSION:0.2.0} mloda-community=={env:MLODA_REGISTRY_VERSION:0.2.0} mloda-enterprise=={env:MLODA_REGISTRY_VERSION:0.2.0} mloda-community-example=={env:MLODA_REGISTRY_VERSION:0.2.0} mloda-community-example-a=={env:MLODA_REGISTRY_VERSION:0.2.0}"
    sh -c "pip-audit --desc --format=json --output=security-reports/pip-audit.json || pip-audit --desc"
    sh -c "echo '=== CVE Scan Complete ==='"
    sh -c "echo 'Report: security-reports/pip-audit.json'"
