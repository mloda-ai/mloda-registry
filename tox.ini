[tox]
envlist = python310 #python310, python311, python312, python313

[testenv]
usedevelop = true
extras = dev
passenv =
    USE_TOX_LOCK
allowlist_externals = sh, bandit
setenv =
    USE_TOX_LOCK = {env:USE_TOX_LOCK:}
commands =
    sh -c "if [ -n \"$USE_TOX_LOCK\" ]; then flock /shared/tox.lock pytest; else pytest; fi"
    ruff format --line-length 120 .
    mypy --strict --ignore-missing-imports .
    bandit -c pyproject.toml -r -q .

[testenv:testing]
description = Run only mloda-testing tests
usedevelop = true
commands =
    pytest mloda/testing/tests/ -v

[testenv:community-example]
description = Run only mloda-community-example tests
usedevelop = true
commands =
    pytest mloda/community/feature_groups/example/tests/ -v

[testenv:community-example-a]
description = Run only mloda-community-example-a tests
usedevelop = true
commands =
    pytest mloda/community/feature_groups/example/example_a/tests/ -v

[testenv:community-example-b]
description = Run only mloda-community-example-b tests
usedevelop = true
commands =
    pytest mloda/community/feature_groups/example/example_b/tests/ -v

[testenv:registry]
description = Run only mloda-registry tests
usedevelop = true
commands =
    pytest mloda/registry/tests/ -v

[testenv:enterprise-example]
description = Run only mloda-enterprise-example tests
usedevelop = true
commands =
    pytest mloda/enterprise/ -v

[testenv:verify-builds]
description = Verify all packages build with correct versions
usedevelop = true
extras = dev
deps = setuptools
allowlist_externals = uv
commands =
    python scripts/verify_builds.py

[testenv:check-generated]
description = Check pyproject.toml files are up-to-date with config
usedevelop = true
extras = dev
commands =
    python scripts/generate_pyproject.py --check

[testenv:verify-published]
description = Verify published packages install and import correctly
skip_install = true
allowlist_externals = sh, uv, rm
commands =
    sh -c 'uv cache clean'
    sh -c 'rm -rf /tmp/mloda-verify && uv venv /tmp/mloda-verify'
    sh -c 'VIRTUAL_ENV=/tmp/mloda-verify uv pip install mloda-registry=={env:MLODA_REGISTRY_VERSION:0.2.8} mloda-testing=={env:MLODA_REGISTRY_VERSION:0.2.8} mloda-community=={env:MLODA_REGISTRY_VERSION:0.2.8} mloda-enterprise=={env:MLODA_REGISTRY_VERSION:0.2.8} mloda-community-example=={env:MLODA_REGISTRY_VERSION:0.2.8} mloda-community-example-a=={env:MLODA_REGISTRY_VERSION:0.2.8}'
    sh -c 'cd /tmp && /tmp/mloda-verify/bin/python -c "from mloda.registry import discover, search; print(\"mloda.registry OK\")"'
    sh -c 'cd /tmp && /tmp/mloda-verify/bin/python -c "from mloda.testing import FeatureGroupTestBase; print(\"mloda.testing OK\")"'
    sh -c 'cd /tmp && /tmp/mloda-verify/bin/python -c "from mloda.community.feature_groups.example import CommunityExampleFeatureGroup; print(\"mloda.community.example OK\")"'
    sh -c 'cd /tmp && /tmp/mloda-verify/bin/python -c "from mloda.community.feature_groups.example.example_a import ExampleAFeatureGroup; print(\"mloda.community.example_a OK\")"'
    sh -c 'cd /tmp && /tmp/mloda-verify/bin/python -c "from mloda.enterprise.feature_groups.example import EnterpriseExampleFeatureGroup; print(\"mloda.enterprise.example OK\")"'
    sh -c 'cd /tmp && /tmp/mloda-verify/bin/python -c "from mloda.community.compute_frameworks.example import CommunityExampleComputeFramework; print(\"mloda.community.compute_frameworks.example OK\")"'
    sh -c 'cd /tmp && /tmp/mloda-verify/bin/python -c "from mloda.community.extenders.example import CommunityExampleExtender; print(\"mloda.community.extenders.example OK\")"'
    sh -c 'cd /tmp && /tmp/mloda-verify/bin/python -c "from mloda.enterprise.compute_frameworks.example import EnterpriseExampleComputeFramework; print(\"mloda.enterprise.compute_frameworks.example OK\")"'
    sh -c 'cd /tmp && /tmp/mloda-verify/bin/python -c "from mloda.enterprise.extenders.example import EnterpriseExampleExtender; print(\"mloda.enterprise.extenders.example OK\")"'
    sh -c 'echo "=== All packages verified ==="'

[testenv:verify-extras]
description = Verify optional dependencies install correctly
skip_install = true
allowlist_externals = sh, uv, rm
commands =
    ; Test mloda-community-example base package (without extras)
    sh -c 'rm -rf /tmp/mloda-verify-base && uv venv /tmp/mloda-verify-base'
    sh -c 'VIRTUAL_ENV=/tmp/mloda-verify-base uv pip install mloda-community-example=={env:MLODA_REGISTRY_VERSION:0.2.8}'
    sh -c 'cd /tmp && /tmp/mloda-verify-base/bin/python -c "from mloda.community.feature_groups.example import CommunityExampleFeatureGroup; print(\"base package OK\")"'
    ; Verify example_a is NOT installed with base (requires [all] extra)
    sh -c 'cd /tmp && /tmp/mloda-verify-base/bin/python -c "from mloda.community.feature_groups.example.example_a import ExampleAFeatureGroup" 2>/dev/null && { echo "ERROR: example_a should NOT be installed with base"; exit 1; } || echo "example_a correctly NOT installed with base"'
    ; Test mloda-community-example[all] installs example_a and example_b
    sh -c 'rm -rf /tmp/mloda-verify-all && uv venv /tmp/mloda-verify-all'
    sh -c 'VIRTUAL_ENV=/tmp/mloda-verify-all uv pip install "mloda-community-example[all]=={env:MLODA_REGISTRY_VERSION:0.2.8}"'
    sh -c 'cd /tmp && /tmp/mloda-verify-all/bin/python -c "from mloda.community.feature_groups.example import CommunityExampleFeatureGroup; print(\"base with [all] OK\")"'
    sh -c 'cd /tmp && /tmp/mloda-verify-all/bin/python -c "from mloda.community.feature_groups.example.example_a import ExampleAFeatureGroup; print(\"example_a with [all] OK\")"'
    sh -c 'cd /tmp && /tmp/mloda-verify-all/bin/python -c "from mloda.community.feature_groups.example.example_b import ExampleBFeatureGroup; print(\"example_b with [all] OK\")"'
    sh -c 'echo "=== Optional dependencies verified ==="'

[testenv:verify-published-independent]
description = Verify each package installs and imports independently
skip_install = true
allowlist_externals = sh, uv, rm
commands =
    ; Test mloda-registry independently
    sh -c 'rm -rf /tmp/mloda-verify-registry && uv venv /tmp/mloda-verify-registry'
    sh -c 'VIRTUAL_ENV=/tmp/mloda-verify-registry uv pip install mloda-registry=={env:MLODA_REGISTRY_VERSION:0.2.8}'
    sh -c 'cd /tmp && /tmp/mloda-verify-registry/bin/python -c "from mloda.registry import discover, search; print(\"mloda-registry independent OK\")"'
    ; Test mloda-testing independently
    sh -c 'rm -rf /tmp/mloda-verify-testing && uv venv /tmp/mloda-verify-testing'
    sh -c 'VIRTUAL_ENV=/tmp/mloda-verify-testing uv pip install mloda-testing=={env:MLODA_REGISTRY_VERSION:0.2.8}'
    sh -c 'cd /tmp && /tmp/mloda-verify-testing/bin/python -c "from mloda.testing import FeatureGroupTestBase; print(\"mloda-testing independent OK\")"'
    ; Test mloda-community independently (without enterprise)
    sh -c 'rm -rf /tmp/mloda-verify-community && uv venv /tmp/mloda-verify-community'
    sh -c 'VIRTUAL_ENV=/tmp/mloda-verify-community uv pip install mloda-community=={env:MLODA_REGISTRY_VERSION:0.2.8}'
    sh -c 'cd /tmp && /tmp/mloda-verify-community/bin/python -c "from mloda.community.feature_groups.example import CommunityExampleFeatureGroup; print(\"mloda-community independent OK\")"'
    ; Test mloda-enterprise independently (without community)
    sh -c 'rm -rf /tmp/mloda-verify-enterprise && uv venv /tmp/mloda-verify-enterprise'
    sh -c 'VIRTUAL_ENV=/tmp/mloda-verify-enterprise uv pip install mloda-enterprise=={env:MLODA_REGISTRY_VERSION:0.2.8}'
    sh -c 'cd /tmp && /tmp/mloda-verify-enterprise/bin/python -c "from mloda.enterprise.feature_groups.example import EnterpriseExampleFeatureGroup; print(\"mloda-enterprise independent OK\")"'
    sh -c 'echo "=== All packages verified independently ==="'

[testenv:security]
description = CVE scanning of published packages
skip_install = true
deps =
    pip-audit
allowlist_externals = sh, mkdir, uv
commands =
    mkdir -p security-reports
    sh -c "uv pip uninstall mloda-registry mloda-testing mloda-community mloda-enterprise mloda-community-example mloda-community-example-a 2>/dev/null || true"
    uv pip install mloda-registry=={env:MLODA_REGISTRY_VERSION:0.2.8} mloda-testing=={env:MLODA_REGISTRY_VERSION:0.2.8} mloda-community=={env:MLODA_REGISTRY_VERSION:0.2.8} mloda-enterprise=={env:MLODA_REGISTRY_VERSION:0.2.8} mloda-community-example=={env:MLODA_REGISTRY_VERSION:0.2.8} mloda-community-example-a=={env:MLODA_REGISTRY_VERSION:0.2.8}
    sh -c "pip-audit --desc --format=json --output=security-reports/pip-audit.json || pip-audit --desc"
    sh -c "echo '=== CVE Scan Complete ==='"
    sh -c "echo 'Report: security-reports/pip-audit.json'"
